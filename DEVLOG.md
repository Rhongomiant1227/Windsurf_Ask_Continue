# Windsurf Ask Continue 开发日记

> 作者：Rhongomiant1227
> 
> 记录我开发这个"无限对话"工具的心路历程

---

## 缘起：有人拿去卖钱了？

某天刷闲鱼，突然看到有人在卖一个叫"AI无限对话"的工具，标价几十块。

点进去一看，功能描述很熟悉——让 Windsurf 的 AI 对话可以无限继续，不会自动结束。

我：？？？

这东西技术壁垒几乎为零好吧。在 Vibe Coding 时代，任何一个会用智能 IDE 的人，花点时间都能做出来。居然有人靠信息差割韭菜？

那我就开源呗，砸场子了属于是。😎

---

## Day 1：搭建基础架构

目标很简单：
1. 写一个 MCP Server（Python），提供 `ask_continue` 工具
2. 写一个 Windsurf 扩展（TypeScript），弹窗询问用户是否继续
3. 两者通过 HTTP 通信

基础版本很快就跑通了。MCP Server 调用扩展，扩展弹窗，用户输入，返回给 AI。

**遇到的第一个坑**：Windsurf 的 MCP 实现和官方文档有些出入，调试了一会儿才搞定消息格式。

---

## Day 2：端口冲突地狱

问题来了：如果用户开了多个 Windsurf 窗口怎么办？

每个窗口的扩展都监听同一个端口，必然冲突。

**解决方案**：
- 扩展使用动态端口，如果默认端口被占用就自动尝试下一个
- 写入端口文件到临时目录，MCP Server 通过读取文件发现可用的扩展端口

调试这个花了不少时间。主要是端口文件的清理逻辑，进程退出后文件残留会导致连接错误端口。

---

## Day 3：图片传输的坑

用户反馈：能不能支持粘贴图片？

行，加。

实现了 Ctrl+V 粘贴和拖拽上传，用 Base64 编码传输。

**踩的坑**：一开始把 Base64 数据当纯文本传给 AI，结果大图片直接把上下文撑爆了，AI 说图片被"截断"了。

**解决方案**：MCP 协议原生支持 `ImageContent` 类型！把图片数据用这个类型返回，AI 就能正确解析了。

```python
from mcp.types import ImageContent

result.append(ImageContent(
    type="image",
    data=base64_data,
    mimeType=f"image/{mime_subtype}",
))
```

这个细节差点没发现，文档里也没怎么提。

---

## Day 4：玄学 Bug —— 消息发出去了但收不到

这是最折磨人的一天。

用户报告：点击"继续"按钮后，消息确实发出去了（有日志），但 AI 那边完全没收到。

排查了半天，发现问题出在**旧进程残留**。

之前的 MCP Server 进程没有正确退出，新的进程启动后监听了新端口，但扩展还在往旧端口发消息。

**解决方案**：在扩展启动时自动清理旧进程。

```typescript
async function cleanupOldMcpProcesses(): Promise<void> {
  // 清理端口 23984-24034 范围内的旧进程
  for (let port = 23984; port <= 24034; port++) {
    // Windows: netstat + taskkill
    // Unix: lsof + kill
  }
}
```

这个功能加上之后，终于稳定了。

---

## Day 5：UI 小优化

- 添加了侧边栏状态面板，显示服务运行状态
- 添加了"重新打开弹窗"命令，防止用户不小心关掉
- 弹窗 UI 美化，支持暗色主题

---

## 总结

这个项目本身技术难度不高，但坑还挺多：

1. **MCP 协议的细节** - 官方文档不够详细，很多要自己摸索
2. **多窗口/多进程场景** - 端口管理和进程清理很容易出问题
3. **图片传输** - 要用对数据类型，不然 AI 解析不了
4. **调试困难** - 涉及 MCP Server + Windsurf 扩展 + AI 三方通信，任何一环出问题都难定位

最后，希望这个工具能帮到大家。

**记住：这东西完全免费，别被人骗钱了！**

---

*2024年12月*

*Rhongomiant1227*
